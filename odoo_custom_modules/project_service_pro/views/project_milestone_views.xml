<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ========================================
         PROJECT MILESTONE VIEWS
         ======================================== -->

    <!-- Vue Liste (Tree) -->
    <record id="view_project_milestone_tree" model="ir.ui.view">
        <field name="name">project.milestone.tree</field>
        <field name="model">project.milestone</field>
        <field name="arch" type="xml">
            <tree string="Jalons de Projet" 
                  decoration-success="state == 'done'" 
                  decoration-info="state == 'in_progress'"
                  decoration-danger="alert_budget or alert_deadline">
                <field name="sequence" widget="handle"/>
                <field name="name"/>
                <field name="project_id"/>
                <field name="partner_id"/>
                <field name="date_start"/>
                <field name="date_end"/>
                <field name="budget_hours" sum="Total Budget"/>
                <field name="hours_consumed" sum="Total Consomm√©"/>
                <field name="progress" widget="progressbar"/>
                <field name="amount" sum="Total Montant"/>
                <field name="state" widget="badge" 
                       decoration-success="state == 'done'"
                       decoration-info="state == 'in_progress'"
                       decoration-warning="state == 'validated'"
                       decoration-muted="state == 'draft'"/>
                <field name="alert_budget" invisible="1"/>
                <field name="alert_deadline" invisible="1"/>
            </tree>
        </field>
    </record>

    <!-- Vue Formulaire -->
    <record id="view_project_milestone_form" model="ir.ui.view">
        <field name="name">project.milestone.form</field>
        <field name="model">project.milestone</field>
        <field name="arch" type="xml">
            <form string="Jalon de Projet">
                <header>
                    <button name="action_start" string="D√©marrer" 
                            type="object" class="oe_highlight"
                            attrs="{'invisible': [('state', 'not in', ['draft', 'planned'])]}"/>
                    <button name="action_complete" string="Marquer comme termin√©" 
                            type="object" class="oe_highlight"
                            attrs="{'invisible': [('state', '!=', 'in_progress')]}"/>
                    <button name="action_validate" string="Valider" 
                            type="object"
                            attrs="{'invisible': [('state', '!=', 'done')]}"/>
                    <button name="action_create_invoice" string="Cr√©er Facture" 
                            type="object" class="oe_highlight"
                            attrs="{'invisible': [('state', 'not in', ['done', 'validated'])]}"/>
                    <field name="state" widget="statusbar" 
                           statusbar_visible="draft,planned,in_progress,done,validated,invoiced"/>
                </header>
                <sheet>
                    <!-- Alertes en haut -->
                    <div class="alert alert-warning" role="alert" 
                         attrs="{'invisible': [('alert_budget', '=', False)]}">
                        <strong>‚ö†Ô∏è Alerte Budget !</strong> Le budget heures est d√©pass√© √† plus de 90%.
                    </div>
                    <div class="alert alert-danger" role="alert" 
                         attrs="{'invisible': [('alert_deadline', '=', False)]}">
                        <strong>üö® Deadline d√©pass√©e !</strong> La date limite est d√©pass√©e.
                    </div>

                    <div class="oe_title">
                        <h1>
                            <field name="name" placeholder="ex: Phase 1 - Analyse fonctionnelle"/>
                        </h1>
                    </div>

                    <group>
                        <group string="Informations G√©n√©rales">
                            <field name="project_id" required="1"/>
                            <field name="partner_id"/>
                            <field name="user_id" string="Responsable"/>
                            <field name="sequence"/>
                        </group>
                        <group string="Dates">
                            <field name="date_start"/>
                            <field name="date_end"/>
                            <field name="date_deadline"/>
                        </group>
                    </group>

                    <group>
                        <group string="Budget et Facturation">
                            <field name="pricing_type" widget="radio"/>
                            <field name="amount" widget="monetary"/>
                            <field name="currency_id" invisible="1"/>
                            <field name="budget_hours"/>
                            <field name="sale_line_id"/>
                            <field name="sale_order_id"/>
                        </group>
                        <group string="Consommation">
                            <field name="hours_consumed"/>
                            <field name="hours_remaining"/>
                            <field name="progress" widget="progressbar"/>
                            <field name="invoice_status" widget="badge"/>
                            <field name="invoice_id"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="√âquipe" name="team">
                            <field name="user_ids" widget="many2many_tags" 
                                   options="{'color_field': 'color', 'no_create_edit': True}"/>
                        </page>

                        <page string="T√¢ches" name="tasks">
                            <field name="task_count" invisible="1"/>
                            <button name="action_view_tasks" type="object" 
                                    string="Voir les t√¢ches" class="oe_link"
                                    attrs="{'invisible': [('task_count', '=', 0)]}"/>
                            <field name="task_ids" context="{'default_project_id': project_id}">
                                <tree>
                                    <field name="name"/>
                                    <field name="user_ids" widget="many2many_tags"/>
                                    <field name="date_deadline"/>
                                    <field name="stage_id"/>
                                </tree>
                            </field>
                        </page>

                        <page string="Feuilles de Temps" name="timesheets">
                            <field name="timesheet_count" invisible="1"/>
                            <button name="action_view_timesheets" type="object" 
                                    string="Voir tout le temps saisi" class="oe_link"
                                    attrs="{'invisible': [('timesheet_count', '=', 0)]}"/>
                            <field name="timesheet_ids" context="{'default_project_id': project_id}">
                                <tree editable="bottom">
                                    <field name="date"/>
                                    <field name="employee_id"/>
                                    <field name="name"/>
                                    <field name="unit_amount" sum="Total Heures"/>
                                    <field name="project_id" invisible="1"/>
                                </tree>
                            </field>
                        </page>

                        <page string="Description" name="description">
                            <field name="description" placeholder="Description d√©taill√©e du jalon, livrables attendus..."/>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Vue Kanban -->
    <record id="view_project_milestone_kanban" model="ir.ui.view">
        <field name="name">project.milestone.kanban</field>
        <field name="model">project.milestone</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile" default_group_by="state">
                <field name="name"/>
                <field name="project_id"/>
                <field name="partner_id"/>
                <field name="progress"/>
                <field name="amount"/>
                <field name="state"/>
                <field name="alert_budget"/>
                <field name="alert_deadline"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="name"/>
                                    </strong>
                                </div>
                                <span class="float-right badge badge-pill" 
                                      t-attf-class="badge-{{state == 'done' ? 'success' : state == 'in_progress' ? 'info' : 'secondary'}}">
                                    <field name="state"/>
                                </span>
                            </div>
                            <div class="o_kanban_record_body">
                                <field name="project_id"/>
                                <div class="text-muted">
                                    <i class="fa fa-user"/> <field name="partner_id"/>
                                </div>
                                <div>
                                    <field name="progress" widget="progressbar"/>
                                </div>
                                <div t-if="record.alert_budget.raw_value" class="text-danger">
                                    <i class="fa fa-warning"/> Budget d√©pass√©
                                </div>
                            </div>
                            <div class="o_kanban_record_bottom">
                                <div class="oe_kanban_bottom_left">
                                    <field name="amount" widget="monetary"/>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Vue Calendrier -->
    <record id="view_project_milestone_calendar" model="ir.ui.view">
        <field name="name">project.milestone.calendar</field>
        <field name="model">project.milestone</field>
        <field name="arch" type="xml">
            <calendar string="Planning Jalons" 
                      date_start="date_start" 
                      date_stop="date_end" 
                      color="project_id"
                      mode="month">
                <field name="name"/>
                <field name="project_id"/>
                <field name="state"/>
            </calendar>
        </field>
    </record>

    <!-- Vue Recherche -->
    <record id="view_project_milestone_search" model="ir.ui.view">
        <field name="name">project.milestone.search</field>
        <field name="model">project.milestone</field>
        <field name="arch" type="xml">
            <search string="Rechercher Jalons">
                <field name="name"/>
                <field name="project_id"/>
                <field name="partner_id"/>
                <field name="user_id"/>
                
                <filter string="En cours" name="in_progress" 
                        domain="[('state', '=', 'in_progress')]"/>
                <filter string="Termin√©s" name="done" 
                        domain="[('state', '=', 'done')]"/>
                <filter string="√Ä facturer" name="to_invoice" 
                        domain="[('invoice_status', '=', 'to_invoice')]"/>
                
                <separator/>
                <filter string="Alerte Budget" name="alert_budget" 
                        domain="[('alert_budget', '=', True)]"/>
                <filter string="Deadline d√©pass√©e" name="alert_deadline" 
                        domain="[('alert_deadline', '=', True)]"/>
                
                <separator/>
                <filter string="Mes Jalons" name="my_milestones" 
                        domain="[('user_id', '=', uid)]"/>
                
                <group expand="0" string="Group By">
                    <filter string="Projet" name="group_project" 
                            context="{'group_by': 'project_id'}"/>
                    <filter string="Client" name="group_partner" 
                            context="{'group_by': 'partner_id'}"/>
                    <filter string="Statut" name="group_state" 
                            context="{'group_by': 'state'}"/>
                    <filter string="Responsable" name="group_user" 
                            context="{'group_by': 'user_id'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Action -->
    <record id="action_project_milestone" model="ir.actions.act_window">
        <field name="name">Jalons de Projet</field>
        <field name="res_model">project.milestone</field>
        <field name="view_mode">tree,form,kanban,calendar</field>
        <field name="context">{
            'search_default_in_progress': 1,
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Cr√©ez votre premier jalon de projet
            </p>
            <p>
                Les jalons permettent de d√©couper vos projets en phases facturables,
                avec un suivi pr√©cis du budget heures et de la facturation.
            </p>
        </field>
    </record>

</odoo>
